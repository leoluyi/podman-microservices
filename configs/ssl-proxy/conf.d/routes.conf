# /etc/nginx/conf.d/routes.conf
# ============================================================================
# 路由配置與驗證規則
# ============================================================================

# HTTP Server（重定向到 HTTPS）
server {
    listen 80;
    server_name _;
    
    location = /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
    
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS Server（主要服務）
server {
    listen 443 ssl http2;
    server_name _;

    # SSL 憑證配置
    ssl_certificate /etc/nginx/ssl/server.crt;
    ssl_certificate_key /etc/nginx/ssl/server.key;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;

    # 安全 Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 變數初始化
    set $jwt_user_id "-";
    set $jwt_client_type "-";

    # ========================================================================
    # 健康檢查（不需要驗證）
    # ========================================================================
    location = /health {
        access_log off;
        return 200 "SSL Proxy OK\n";
        add_header Content-Type text/plain;
    }

    # ========================================================================
    # 前端靜態資源（不需要驗證）
    # ========================================================================
    location / {
        proxy_pass http://frontend;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # ========================================================================
    # Web/App API（轉發給 BFF，由 BFF 處理 Session 認證）
    # ========================================================================
    location /api/ {
        proxy_pass http://bff/api/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Connection "";

        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ========================================================================
    # Partner API - User（JWT Token 驗證 + 權限檢查）
    # ========================================================================
    location /partner/api/user/ {
        access_log /var/log/nginx/partner-access.log jwt_log;

        # Partner JWT 驗證和權限檢查
        access_by_lua_block {
            local partner_auth = require "partner-auth"
            partner_auth.verify_and_check_permission("users", "read")
        }

        proxy_pass http://api-user/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Connection "";

        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # ========================================================================
    # Partner API - Order（JWT Token 驗證 + 權限檢查）
    # ========================================================================
    location /partner/api/order/ {
        access_log /var/log/nginx/partner-access.log jwt_log;

        # Partner JWT 驗證和權限檢查（根據 HTTP 方法判斷操作類型）
        access_by_lua_block {
            local partner_auth = require "partner-auth"
            local action = "read"

            -- POST, PUT, PATCH, DELETE 需要 write 權限
            if ngx.req.get_method() == "POST" or
               ngx.req.get_method() == "PUT" or
               ngx.req.get_method() == "PATCH" then
                action = "write"
            elseif ngx.req.get_method() == "DELETE" then
                action = "delete"
            end

            partner_auth.verify_and_check_permission("orders", action)
        }

        proxy_pass http://api-order/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Connection "";

        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # ========================================================================
    # Partner API - Product（JWT Token 驗證 + 權限檢查）
    # ========================================================================
    location /partner/api/product/ {
        access_log /var/log/nginx/partner-access.log jwt_log;

        # Partner JWT 驗證和權限檢查（根據 HTTP 方法判斷操作類型）
        access_by_lua_block {
            local partner_auth = require "partner-auth"
            local action = "read"

            -- POST, PUT, PATCH, DELETE 需要 write 權限
            if ngx.req.get_method() == "POST" or
               ngx.req.get_method() == "PUT" or
               ngx.req.get_method() == "PATCH" then
                action = "write"
            elseif ngx.req.get_method() == "DELETE" then
                action = "delete"
            end

            partner_auth.verify_and_check_permission("products", action)
        }

        proxy_pass http://api-product/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Connection "";

        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # 錯誤頁面
    error_page 401 @error401;
    location @error401 {
        default_type application/json;
        return 401 '{"error":"Unauthorized"}';
    }

    error_page 500 502 503 504 @error5xx;
    location @error5xx {
        default_type application/json;
        return 500 '{"error":"Internal Server Error"}';
    }
}
