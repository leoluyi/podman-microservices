# /etc/nginx/conf.d/routes.conf
# ============================================================================
# 路由配置與驗證規則
# ============================================================================

# HTTP Server（重定向到 HTTPS）
server {
    listen 80;
    server_name _;
    
    location = /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
    
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS Server（主要服務）
server {
    listen 443 ssl http2;
    server_name _;

    # SSL 憑證配置
    ssl_certificate /etc/nginx/ssl/server.crt;
    ssl_certificate_key /etc/nginx/ssl/server.key;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;

    # 安全 Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 變數初始化
    set $jwt_user_id "-";
    set $jwt_client_type "-";

    # ========================================================================
    # 健康檢查（不需要驗證）
    # ========================================================================
    location = /health {
        access_log off;
        return 200 "SSL Proxy OK\n";
        add_header Content-Type text/plain;
    }

    # ========================================================================
    # 前端靜態資源（不需要驗證）
    # ========================================================================
    location / {
        proxy_pass http://frontend;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # ========================================================================
    # Web/App API（轉發給 BFF，由 BFF 處理 Session 認證）
    # ========================================================================
    location /api/ {
        proxy_pass http://bff/api/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Connection "";

        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ========================================================================
    # Partner API - Order（JWT Token 驗證）
    # ========================================================================
    location /partner/api/order/ {
        access_log /var/log/nginx/partner-access.log jwt_log;

        # Partner JWT 驗證
        access_by_lua_block {
            local auth_header = ngx.var.http_authorization

            if not auth_header then
                ngx.log(ngx.ERR, "Partner API: Missing Authorization from ", ngx.var.remote_addr)
                ngx.status = ngx.HTTP_UNAUTHORIZED
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"Unauthorized","message":"Missing Authorization header"}')
                return ngx.exit(ngx.HTTP_UNAUTHORIZED)
            end

            local _, _, token = string.find(auth_header, "Bearer%s+(.+)")

            if not token then
                ngx.log(ngx.ERR, "Partner API: Invalid format from ", ngx.var.remote_addr)
                ngx.status = ngx.HTTP_UNAUTHORIZED
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"Unauthorized","message":"Invalid Authorization format"}')
                return ngx.exit(ngx.HTTP_UNAUTHORIZED)
            end

            local jwt_obj = jwt:verify(jwt_secret, token)

            if not jwt_obj.verified then
                ngx.log(ngx.ERR, "Partner API: JWT verification failed - ", jwt_obj.reason)
                ngx.status = ngx.HTTP_UNAUTHORIZED
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"Unauthorized","message":"Invalid or expired token"}')
                return ngx.exit(ngx.HTTP_UNAUTHORIZED)
            end

            if not jwt_obj.payload.sub then
                ngx.log(ngx.ERR, "Partner API: Token missing sub claim")
                ngx.status = ngx.HTTP_UNAUTHORIZED
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"Unauthorized","message":"Token missing partner ID"}')
                return ngx.exit(ngx.HTTP_UNAUTHORIZED)
            end

            ngx.var.jwt_user_id = jwt_obj.payload.sub
            ngx.var.jwt_client_type = "partner"

            ngx.req.set_header("X-Partner-ID", jwt_obj.payload.sub)
            ngx.log(ngx.INFO, "Authenticated partner: ", jwt_obj.payload.sub)
        }

        proxy_pass http://api-order/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Connection "";

        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # ========================================================================
    # Partner API - Product（JWT Token 驗證）
    # ========================================================================
    location /partner/api/product/ {
        access_log /var/log/nginx/partner-access.log jwt_log;

        # Partner JWT 驗證
        access_by_lua_block {
            local auth_header = ngx.var.http_authorization

            if not auth_header then
                ngx.log(ngx.ERR, "Partner API: Missing Authorization from ", ngx.var.remote_addr)
                ngx.status = ngx.HTTP_UNAUTHORIZED
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"Unauthorized","message":"Missing Authorization header"}')
                return ngx.exit(ngx.HTTP_UNAUTHORIZED)
            end

            local _, _, token = string.find(auth_header, "Bearer%s+(.+)")

            if not token then
                ngx.log(ngx.ERR, "Partner API: Invalid format from ", ngx.var.remote_addr)
                ngx.status = ngx.HTTP_UNAUTHORIZED
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"Unauthorized","message":"Invalid Authorization format"}')
                return ngx.exit(ngx.HTTP_UNAUTHORIZED)
            end

            local jwt_obj = jwt:verify(jwt_secret, token)

            if not jwt_obj.verified then
                ngx.log(ngx.ERR, "Partner API: JWT verification failed - ", jwt_obj.reason)
                ngx.status = ngx.HTTP_UNAUTHORIZED
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"Unauthorized","message":"Invalid or expired token"}')
                return ngx.exit(ngx.HTTP_UNAUTHORIZED)
            end

            if not jwt_obj.payload.sub then
                ngx.log(ngx.ERR, "Partner API: Token missing sub claim")
                ngx.status = ngx.HTTP_UNAUTHORIZED
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"error":"Unauthorized","message":"Token missing partner ID"}')
                return ngx.exit(ngx.HTTP_UNAUTHORIZED)
            end

            ngx.var.jwt_user_id = jwt_obj.payload.sub
            ngx.var.jwt_client_type = "partner"

            ngx.req.set_header("X-Partner-ID", jwt_obj.payload.sub)
            ngx.log(ngx.INFO, "Authenticated partner: ", jwt_obj.payload.sub)
        }

        proxy_pass http://api-product/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Connection "";

        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # 錯誤頁面
    error_page 401 @error401;
    location @error401 {
        default_type application/json;
        return 401 '{"error":"Unauthorized"}';
    }

    error_page 500 502 503 504 @error5xx;
    location @error5xx {
        default_type application/json;
        return 500 '{"error":"Internal Server Error"}';
    }
}
