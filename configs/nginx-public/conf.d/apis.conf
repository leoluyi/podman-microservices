# ============================================================================
# Public API Gateway - 路由配置
# ============================================================================
# 此檔案定義對外開放的 API 路由
# 只有 api-order 和 api-product 透過此 Gateway 對外開放
# ============================================================================

server {
    listen 80;
    server_name _;

    # ========================================================================
    # 健康檢查端點（不需要 API Key）
    # ========================================================================
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # ========================================================================
    # API Order 服務（需要 API Key）
    # ========================================================================
    location /api/order/ {
        # API Key 驗證
        if ($api_client_name = "") {
            return 401 '{"error":"Unauthorized","message":"Missing or invalid API Key"}';
        }

        # 可選：Rate Limiting
        # limit_req zone=api_limit burst=20 nodelay;

        # 反向代理到內部 API-Order 服務
        # 使用容器名稱（Podman DNS 自動解析）
        proxy_pass http://api-order:8082/;

        # Proxy Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 傳遞客戶名稱給後端（可用於審計）
        proxy_set_header X-Client-Name $api_client_name;

        # 超時設定
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        # 錯誤處理
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
    }

    # ========================================================================
    # API Product 服務（需要 API Key）
    # ========================================================================
    location /api/product/ {
        # API Key 驗證
        if ($api_client_name = "") {
            return 401 '{"error":"Unauthorized","message":"Missing or invalid API Key"}';
        }

        # 可選：Rate Limiting
        # limit_req zone=api_limit burst=20 nodelay;

        # 反向代理到內部 API-Product 服務
        proxy_pass http://api-product:8083/;

        # Proxy Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Client-Name $api_client_name;

        # 超時設定
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        # 錯誤處理
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
    }

    # ========================================================================
    # 進階：不同權限級別的路由（可選）
    # ========================================================================
    # 範例：只有特定客戶可以訪問某些端點
    #
    # location /api/order/admin/ {
    #     # 只允許 admin-client
    #     if ($api_client_name != "admin-client") {
    #         return 403 '{"error":"Forbidden","message":"Insufficient permissions"}';
    #     }
    #     proxy_pass http://api-order:8082/admin/;
    # }

    # ========================================================================
    # 預設：拒絕其他所有請求
    # ========================================================================
    location / {
        return 404 '{"error":"Not Found","message":"API endpoint not found"}';
        add_header Content-Type application/json;
    }

    # ========================================================================
    # 錯誤頁面自訂
    # ========================================================================
    error_page 401 @error401;
    location @error401 {
        return 401 '{"error":"Unauthorized","message":"Invalid or missing API Key in X-API-Key header"}';
        add_header Content-Type application/json;
    }

    error_page 403 @error403;
    location @error403 {
        return 403 '{"error":"Forbidden","message":"Access denied"}';
        add_header Content-Type application/json;
    }

    error_page 500 502 503 504 @error5xx;
    location @error5xx {
        return 500 '{"error":"Internal Server Error","message":"Service temporarily unavailable"}';
        add_header Content-Type application/json;
    }
}
