#!/bin/bash
# ============================================================================
# 清理環境（停止服務、移除容器、移除配置）
# ============================================================================

set -e

RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

danger() {
    echo -e "${RED}[DANGER]${NC} $1"
}

echo ""
danger "=========================================="
danger "⚠️  警告：此操作將清理所有部署"
danger "=========================================="
echo ""
warning "此腳本將："
echo "  1. 停止所有服務"
echo "  2. 移除所有容器"
echo "  3. 移除網路"
echo "  4. 移除 Quadlet 配置檔"
echo "  5. (可選) 移除應用資料"
echo ""

read -p "確定要繼續嗎？ (yes/no): " confirm

if [ "$confirm" != "yes" ]; then
    info "已取消"
    exit 0
fi

echo ""
info "開始清理..."
echo ""

# ============================================================================
# 1. 停止所有服務
# ============================================================================
info "停止所有服務..."
./scripts/stop-all.sh 2>/dev/null || true
sleep 2

# ============================================================================
# 2. 移除容器
# ============================================================================
info "移除容器..."
podman rm -f api-user api-order api-product public-nginx bff frontend 2>/dev/null || true

# ============================================================================
# 3. 移除網路
# ============================================================================
info "移除網路..."
podman network rm internal-net 2>/dev/null || true

# ============================================================================
# 4. 移除 Quadlet 配置
# ============================================================================
info "移除 Quadlet 配置..."
rm -rf ~/.config/containers/systemd/api-*.container
rm -rf ~/.config/containers/systemd/api-*.container.d
rm -rf ~/.config/containers/systemd/public-nginx.container
rm -rf ~/.config/containers/systemd/bff.container
rm -rf ~/.config/containers/systemd/frontend.container
rm -rf ~/.config/containers/systemd/internal-net.network

# ============================================================================
# 5. 重新載入 systemd
# ============================================================================
info "重新載入 systemd..."
systemctl --user daemon-reload

# ============================================================================
# 6. 清理應用資料（可選）
# ============================================================================
echo ""
read -p "是否要移除應用資料目錄 (/opt/app)？ (yes/no): " remove_data

if [ "$remove_data" == "yes" ]; then
    info "移除應用資料..."
    sudo rm -rf /opt/app
    info "應用資料已移除"
else
    info "保留應用資料"
fi

# ============================================================================
# 完成
# ============================================================================
echo ""
info "=========================================="
info "清理完成！"
info "=========================================="
echo ""
info "如需重新部署，請執行："
echo "  ./scripts/setup.sh {dev|prod}"
echo ""
